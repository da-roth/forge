##############################################################################
#
#  Build & Test Forge C API
#
#  Builds and tests the C API shared library on supported platforms.
#  Artifacts are stored for 90 days.
#
#  macOS is disabled - ARM/NEON instruction sets not yet implemented.
#
#  Copyright (c) 2025 The Forge Authors
#  SPDX-License-Identifier: Zlib
#
##############################################################################

name: Build & Test C API

on:
  push:
    branches: [ main, develop, 'v*' ]
    paths:
      - 'api/c/**'
      - 'src/**'
      - '.github/workflows/ci-capi.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'api/c/**'
      - 'src/**'
      - '.github/workflows/ci-capi.yml'
  workflow_dispatch:

jobs:
  windows:
    name: Windows
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release, Debug]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      - name: Configure
        run: |
          cmake -B build -S api/c -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} `
            -DFORGE_CAPI_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build

      - name: Test
        run: |
          cd build
          ctest --output-on-failure --timeout 120

      - name: Install
        if: matrix.config == 'Release'
        run: cmake --install build --prefix dist

      - name: Upload artifacts
        if: matrix.config == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: forge-capi-windows-x64
          path: dist/
          retention-days: 90

  linux:
    name: Linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [Release, Debug]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Configure
        run: |
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DFORGE_CAPI_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build

      - name: Test
        run: |
          cd build
          ctest --output-on-failure --timeout 120

      - name: Install
        if: matrix.config == 'Release'
        run: cmake --install build --prefix dist

      - name: Upload artifacts
        if: matrix.config == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: forge-capi-linux-x64
          path: dist/
          retention-days: 90

  # macOS builds disabled - ARM/NEON instruction sets not yet implemented
  # TODO: Re-enable when ARM/NEON support is added
