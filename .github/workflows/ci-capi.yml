name: CI C API

on:
  push:
    branches: [ main, develop, 'v*' ]
    paths:
      - 'api/c/**'
      - 'src/**'
      - '.github/workflows/ci-capi.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'api/c/**'
      - 'src/**'
      - '.github/workflows/ci-capi.yml'
  workflow_dispatch:

jobs:
  build_windows:
    name: Windows
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release, Debug]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      - name: Configure
        run: |
          cmake -B build -S api/c -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} `
            -DFORGE_CAPI_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build

      - name: Test
        run: |
          cd build
          ctest --output-on-failure --timeout 120

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: forge-capi-windows-${{ matrix.config }}
          path: |
            build/forge_capi.dll
            build/forge_capi.lib
            api/c/forge_c_api.h

  build_linux:
    name: Linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [Release, Debug]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Configure
        run: |
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DFORGE_CAPI_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build

      - name: Test
        run: |
          cd build
          ctest --output-on-failure --timeout 120

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: forge-capi-linux-${{ matrix.config }}
          path: |
            build/libforge_capi.so*
            api/c/forge_c_api.h

  # macOS builds disabled - ARM support not yet implemented
  # TODO: Re-enable when ARM/NEON instruction sets are added
  # build_macos:
  #   name: macOS
  #   runs-on: macos-latest
  #   ...
  # build_macos_arm:
  #   name: macOS ARM
  #   runs-on: macos-14
  #   ...
